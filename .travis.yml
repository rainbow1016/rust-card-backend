language: minimal

os:
  - linux

services:
  - docker

before_script:
  - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD

jobs:
  include:
    - stage: build
      script:
        - ./build-image.sh public-api
        - ./build-image.sh internal-api

        - docker images

    - stage: push latest
      if: branch = master AND type != pull_request
      script:
        - ./build-tag.sh public-api latest
        - ./build-tag.sh internal-api latest

    - stage: push nightly
      if: branch = dev AND type != pull_request
      script:
        - ./build-tag.sh public-api nightly
        - ./build-tag.sh internal-api nightly

    - stage: push tag
      if: tag =~ /^howtocards-public-api\/\d+\.\d+\.\d+/
      script:
        - ./build-tag.sh public-api $TRAVIS_TAG

    - stage: push tag
      if: tag =~ /^howtocards-internal-api\/\d+\.\d+\.\d+/
      script:
        - ./build-tag.sh internal-api $TRAVIS_TAG
